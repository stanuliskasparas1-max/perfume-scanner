<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Store POS (Web)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{--bg:#0f1012;--card:#17181c;--txt:#fff;--muted:#b6bdc6;--pri:#00aaff;--pri2:#0088cc;--ok:#00ff99;--warn:#ffcc00;--err:#ff5050}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;min-height:100vh}
    .hidden{display:none}
    .btn{font-size:1.06rem;padding:12px 18px;margin:8px;border:none;border-radius:12px;background:var(--pri);color:#fff;cursor:pointer}
    .btn:hover{background:var(--pri2)}
    .btn-ghost{background:#2a2f36}
    .btn-danger{background:#c83532}
    .card{width:92vw;max-width:800px;background:var(--card);padding:16px;border-radius:16px;box-shadow:0 0 24px rgba(0,0,0,.35);margin:12px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.row>*{flex:1}
    label{font-weight:600}
    input,select{width:100%;padding:12px;border:none;border-radius:10px;margin:6px 0;font-size:1.05rem;background:#20242b;color:#fff}
    h1,h2,h3{margin:10px 0 6px}
    .tag{display:inline-block;background:#232833;border:1px solid #2e3440;border-radius:10px;padding:5px 8px;margin:3px;font-size:.95rem;color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    #scannerWrap{position:relative;width:100vw;height:72vh;max-height:74vh}
    #scanner{width:100%;height:100%}
    #flash{position:absolute;inset:0;background:rgba(0,255,100,.35);display:none;animation:flash .25s ease-out;pointer-events:none}
    #scanBadge{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(15,16,18,.85);border:2px solid #00ffaa;box-shadow:0 0 30px rgba(0,255,170,.45);padding:10px 16px;border-radius:999px;font-weight:700;display:none}
    @keyframes flash{from{opacity:1}to{opacity:0}}
    #popup{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#2c313a;padding:10px 16px;border-radius:10px;display:none;border:1px solid #3a404c}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}.chip{padding:8px 12px;border-radius:999px;background:#232833;border:1px solid #2e3440;cursor:pointer}.chip:hover{background:#2a3040}
    .muted{opacity:.85;color:var(--muted)} .divider{height:1px;background:#242932;margin:10px 0}
    table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #242932;text-align:left}
  </style>
</head>
<body>
  <!-- Login -->
  <div id="login" class="card">
    <h1>Prisijungimas</h1>
    <input id="loginCode" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Įveskite vartotojo kodą" />
    <div class="row"><button class="btn" onclick="doLogin()">Prisijungti</button></div>
    <div class="muted">Versija: <span id="ver">v2.9.0</span></div>
  </div>

  <!-- Home -->
  <div id="home" class="card hidden">
    <h1>Store POS</h1>
    <div id="who" class="muted"></div>
    <div id="menuButtons" class="row" style="margin-top:8px"></div>
    <div class="divider"></div>
    <div class="row">
      <button class="btn btn-ghost" onclick="syncNow()">Sync now</button>
      <button class="btn btn-danger" onclick="logout()">Atsijungti</button>
    </div>
  </div>

  <!-- Scanner -->
  <div id="scannerScreen" class="hidden">
    <div id="scannerWrap">
      <div id="scanner"></div>
      <div id="flash"></div>
      <div id="scanBadge">SCANNED</div>
    </div>
    <div class="row" style="padding:8px 12px;max-width:800px;width:92vw">
      <button class="btn btn-ghost" onclick="goHome()">Grįžti</button>
    </div>
  </div>

  <!-- SELL -->
  <div id="sellPanel" class="card hidden">
    <h2>Pardavimas</h2>
    <div id="sellInfo" class="muted"></div>
    <div class="chips hidden" id="sellChips"></div>
    <div class="row">
      <div>
        <label id="qtyLabel" for="qtyInput">Kiekis</label>
        <input id="qtyInput" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Įveskite kiekį" />
      </div>
      <div>
        <label>Kaina / vnt</label>
        <div class="row" style="gap:6px">
          <input id="priceInput" type="tel" inputmode="decimal" placeholder="0,00" disabled />
          <button class="btn" onclick="enableOverride()">Keisti kainą</button>
        </div>
      </div>
    </div>
    <div class="row">
      <button class="btn" onclick="confirmSale()">ENTER</button>
      <button class="btn btn-ghost" onclick="scanAgain()">Skenuoti vėl</button>
      <button class="btn btn-ghost" onclick="goHome()">Grįžti</button>
    </div>
  </div>

  <!-- IN EXISTING -->
  <div id="inPanel" class="card hidden">
    <h2>Prekių priėmimas</h2>
    <div id="inInfo" class="muted"></div>
    <label>Gautas kiekis</label>
    <input id="inQty" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Kiekis" />
    <div class="row">
      <button class="btn" onclick="confirmIn()">Įrašyti</button>
      <button class="btn btn-ghost" onclick="scanAgain()">Skenuoti vėl</button>
      <button class="btn btn-ghost" onclick="goHome()">Grįžti</button>
    </div>
  </div>

  <!-- IN NEW -->
  <div id="inNewPanel" class="card hidden">
    <h2>Nauja prekė</h2>
    <div><b>EAN:</b> <span id="newEAN"></span></div>
    <label>Pavadinimas</label>
    <input id="newName" placeholder="Pvz., Dior Sauvage" />
    <label>Vienetas</label>
    <select id="newUnit"><option value="ml">ml (kvepalai)</option><option value="pcs">vnt (kitos prekės)</option></select>
    <label>Bazinė kaina / vienetui</label>
    <input id="newPrice" type="tel" inputmode="decimal" placeholder="0,00" />
    <label>Gautas kiekis</label>
    <input id="newQty" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Kiekis" />
    <div class="row">
      <button class="btn" onclick="saveNewAndIn()">Išsaugoti ir įrašyti</button>
      <button class="btn btn-ghost" onclick="scanAgain()">Skenuoti vėl</button>
      <button class="btn btn-ghost" onclick="goHome()">Grįžti</button>
    </div>
  </div>

  <!-- CHECK STOCK -->
  <div id="chkPanel" class="card hidden">
    <h2>Tikrinti likutį</h2>
    <div id="chkInfo" class="muted"></div>
    <div class="row">
      <button class="btn" onclick="scanAgain()">Skenuoti vėl</button>
      <button class="btn btn-ghost" onclick="goHome()">Grįžti</button>
    </div>
  </div>

  <!-- GLOBAL PRICE (222) -->
  <div id="pricePanel" class="card hidden">
    <h2>Keisti kainą (visam stockui)</h2>
    <div id="priceInfo" class="muted"></div>
    <label>Nauja kaina / vienetui</label>
    <input id="priceNew" type="tel" inputmode="decimal" placeholder="0,00" />
    <div class="row">
      <button class="btn" onclick="confirmGlobalPrice()">Patvirtinti kainą</button>
      <button class="btn btn-ghost" onclick="scanAgain()">Skenuoti vėl</button>
      <button class="btn btn-ghost" onclick="goHome()">Grįžti</button>
    </div>
  </div>

  <!-- INVENTORY (333) -->
  <div id="invStart" class="card hidden">
    <h2>Inventorizacija</h2>
    <label>Inventorizacijos data</label>
    <input id="invDate" type="date" />
    <div class="row">
      <button class="btn" onclick="startInventory()">Pradėti inventorizaciją</button>
      <button class="btn btn-ghost" onclick="goHome()">Grįžti</button>
    </div>
  </div>

  <div id="invCount" class="card hidden">
    <h2>Skaičiavimas</h2>
    <div id="invInfo" class="muted"></div>
    <label>Naujas suskaičiuotas kiekis</label>
    <input id="invQty" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Kiekis" />
    <div class="row">
      <button class="btn" onclick="confirmInvCount()">Įrašyti ir kitas</button>
      <button class="btn btn-ghost" onclick="scanAgain()">Skenuoti vėl</button>
      <button class="btn btn-ghost" onclick="closeInventory()">Uždaryti inventorizaciją</button>
    </div>
  </div>

  <!-- REPORT -->
  <div id="reportPanel" class="card hidden">
    <h2 id="reportTitle">Ataskaita</h2>
    <div id="reportInfo" class="muted"></div>
    <table id="reportTable"><thead><tr><th>EAN</th><th>Pavadinimas</th><th>Vnt</th><th>€</th></tr></thead><tbody></tbody></table>
    <div class="row"><button class="btn btn-ghost" onclick="goHome()">Grįžti</button></div>
  </div>

  <!-- SETTINGS (444) -->
  <div id="settings" class="card hidden">
    <h2>Nustatymai (IT)</h2>
    <div id="invStatus" class="muted">Būsena: —</div>
    <div class="divider"></div>
    <h3>Diagnostika</h3>
    <div class="row">
      <button class="btn btn-ghost" onclick="syncNow()">Sync now</button>
      <button class="btn btn-ghost" onclick="testOut()">Test OUT</button>
      <button class="btn btn-ghost" onclick="testIn()">Test IN</button>
      <button class="btn btn-danger" onclick="resetApp()">Reset app</button>
    </div>
    <div class="muted" id="diagInfo">—</div>
  </div>

  <div id="popup"></div>

  <script src="https://unpkg.com/html5-qrcode?v=2"></script>
  <script>
    /* ===== URLs ===== */
    const OUT_URL = "https://script.google.com/macros/s/AKfycbwuu6IvwkwvubIpg9zSbuT9Alj_cZcWWxSM62ZVt2z3zf3IxiwxdtLMor1IRt943lg9uQ/exec";
    const IN_URL  = "https://script.google.com/macros/s/AKfycbztiJK4J-wqvPnYYI_MPnXVxEMVrUwf8s6G35NvXq8Q4-Q_eosz5NzOwkaieoLhycFv/exec";
    const INV_URL = "https://script.google.com/macros/s/AKfycbx8lt1QANX-cXF1WyNx9fon7Ei6G4qWksnpW9cu-qlnr1DhWp-_h39vx8PdMM-oQHUGhQ/exec";
    const APP_VERSION = "v2.9.0";

    /* ===== STATE ===== */
    let currentUser=null, html5Qr=null, lastEAN=null, currentRoute=null;
    let products = JSON.parse(localStorage.getItem("products_cache")||"{}");
    let stockMap={}, inventoryActive=false, lastInvStart=null;
    let queue = JSON.parse(localStorage.getItem("send_queue")||"[]");

    /* ===== UI refs ===== */
    const login=document.getElementById("login"), loginCode=document.getElementById("loginCode");
    const home=document.getElementById("home"), who=document.getElementById("who"), menuButtons=document.getElementById("menuButtons");
    document.getElementById("ver").textContent=APP_VERSION;
    const scannerScreen=document.getElementById("scannerScreen"), flash=document.getElementById("flash"), scanBadge=document.getElementById("scanBadge");
    const sellPanel=document.getElementById("sellPanel"), sellInfo=document.getElementById("sellInfo"), sellChips=document.getElementById("sellChips");
    const qtyLabel=document.getElementById("qtyLabel"), qtyInput=document.getElementById("qtyInput"), priceInput=document.getElementById("priceInput");
    const inPanel=document.getElementById("inPanel"), inInfo=document.getElementById("inInfo"), inQty=document.getElementById("inQty");
    const inNewPanel=document.getElementById("inNewPanel"), newEAN=document.getElementById("newEAN"), newName=document.getElementById("newName"), newUnit=document.getElementById("newUnit"), newPrice=document.getElementById("newPrice"), newQty=document.getElementById("newQty");
    const chkPanel=document.getElementById("chkPanel"), chkInfo=document.getElementById("chkInfo");
    const pricePanel=document.getElementById("pricePanel"), priceInfo=document.getElementById("priceInfo"), priceNew=document.getElementById("priceNew");
    const invStart=document.getElementById("invStart"), invCount=document.getElementById("invCount"), invDate=document.getElementById("invDate"), invInfo=document.getElementById("invInfo"), invQty=document.getElementById("invQty");
    const reportPanel=document.getElementById("reportPanel"), reportTitle=document.getElementById("reportTitle"), reportInfo=document.getElementById("reportInfo"), reportTable=document.getElementById("reportTable").querySelector("tbody");
    const settings=document.getElementById("settings"), invStatus=document.getElementById("invStatus"), diagInfo=document.getElementById("diagInfo");

    /* ===== utils ===== */
    function show(el){ el.classList.remove("hidden"); } function hide(el){ el.classList.add("hidden"); }
    function popup(msg){ const p=document.getElementById("popup"); p.textContent=msg; p.style.display="block"; setTimeout(()=>p.style.display="none", 2800); }
    function saveProducts(){ localStorage.setItem("products_cache", JSON.stringify(products)); }
    function saveQueue(){ localStorage.setItem("send_queue", JSON.stringify(queue.slice(-200))); }
    function enqueue(url,payload){ queue.push({url, payload, ts:Date.now()}); saveQueue(); }

    // audio + haptics
    let beepCtx=null; function initAudio(){ if (beepCtx) return; try{ beepCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch{} }
    function beep(){ if (!beepCtx) return; try{ const o=beepCtx.createOscillator(), g=beepCtx.createGain(); o.type="square"; o.frequency.setValueAtTime(1100, beepCtx.currentTime); g.gain.value=.07; o.connect(g).connect(beepCtx.destination); o.start(); o.stop(beepCtx.currentTime+.08);}catch{} }
    function vibrate(ms=45){ if (navigator.vibrate) try{ navigator.vibrate(ms);}catch{} }
    function flashFX(){ flash.style.display="block"; scanBadge.style.display="block"; setTimeout(()=>{flash.style.display="none"; scanBadge.style.display="none";}, 320); }
    function parseCommaNumber(x){ if (typeof x==="number") return x; if (!x) return 0; return Number(String(x).trim().replace(",", ".")); }
    function formatEUR(n){ const v=Number(n||0); return v.toFixed(2).replace(".", ",")+" €"; }

    /* ===== login ===== */
    function roleByCode(code){ if (code==="111") return "Pardavėja"; if (code==="222") return "Savininkas"; if (code==="333") return "Inventorizacija"; if (code==="444") return "IT"; return null; }
    function doLogin(){ initAudio(); const code=(loginCode.value||"").trim(); const role=roleByCode(code); if (!role){ popup("Neteisingas kodas"); return; } currentUser={id:code, role}; loginCode.value=""; showHome(); syncNow(); }
    function logout(){ stopScanner(); currentUser=null; [home,scannerScreen,sellPanel,inPanel,inNewPanel,chkPanel,pricePanel,invStart,invCount,reportPanel,settings].forEach(hide); show(login); }

    /* ===== home/menu ===== */
    function showHome(){ hide(login); show(home); who.textContent=`Prisijungęs: ${currentUser.role}`; buildMenu(); [scannerScreen,sellPanel,inPanel,inNewPanel,chkPanel,pricePanel,invStart,invCount,reportPanel,settings].forEach(hide); }
    function buildMenu(){
      menuButtons.innerHTML="";
      const add=(t,fn)=>{ const b=document.createElement("button"); b.className="btn"; b.textContent=t; b.onclick=fn; menuButtons.appendChild(b); };
      if (currentUser.id==="111"){ add("Parduoti", ()=>goRoute("sell")); add("Prekių priėmimas", ()=>goRoute("in")); add("Tikrinti likutį", ()=>goRoute("check")); }
      else if (currentUser.id==="222"){ add("Parduoti", ()=>goRoute("sell")); add("Prekių priėmimas", ()=>goRoute("in")); add("Tikrinti likutį", ()=>goRoute("check")); add("Keisti kainą (globaliai)", ()=>goRoute("price")); add("Dienos pardavimai", showDailySales); }
      else if (currentUser.id==="333"){ add("Inventorizacija", ()=>goRoute("inventory")); }
      else if (currentUser.id==="444"){ add("Nustatymai (IT)", ()=>goRoute("settings")); }
    }

    /* ===== routing ===== */
    function goRoute(r){ currentRoute=r; hide(home);
      if (r==="sell"||r==="in"||r==="check"||r==="price"||r==="inventory-scan"){ startScanner(); }
      if (r==="inventory"){ hide(scannerScreen); show(invStart); hide(invCount); }
      if (r==="settings"){ hide(scannerScreen); show(settings); refreshStatus(); }
    }
    function goHome(){ stopScanner(); showHome(); }

    /* ===== scanner ===== */
    function startScanner(){ show(scannerScreen); lastEAN=null; stopScanner();
      new Html5Qrcode("scanner").start({facingMode:"environment"},{
        fps:30, qrbox:{width:320,height:220},
        experimentalFeatures:{useBarCodeDetectorIfSupported:true},
        formatsToSupport:[
          Html5QrcodeSupportedFormats.EAN_13,Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,Html5QrcodeSupportedFormats.UPC_E,
          Html5QrcodeSupportedFormats.CODE_128,Html5QrcodeSupportedFormats.CODE_39,
          Html5QrcodeSupportedFormats.QR_CODE
        ], rememberLastUsedCamera:true
      }, (txt)=>{
        if (lastEAN) return;
        lastEAN=String(txt).trim(); vibrate(); beep(); flashFX();
        stopScanner(); handleEAN(lastEAN);
      }).then(h=>{ html5Qr=h; }).catch(console.error);
    }
    function stopScanner(){ if (html5Qr){ try{ html5Qr.stop(); }catch{} } }
    function restartScannerFlow(){ [sellPanel,inPanel,inNewPanel,chkPanel,pricePanel,invCount].forEach(hide); lastEAN=null; startScanner(); }
    function scanAgain(){ restartScannerFlow(); }

    /* ===== stock via INVENTORY backend ===== */
    function jsonp(url,cb){ const s=document.createElement("script"); s.src=url+(url.includes("?")?"&":"?")+"callback="+cb+"&_="+Date.now(); document.body.appendChild(s); s.onload=()=>s.remove(); }
    function loadStock(){ jsonp(INV_URL+"?fn=stock","onStock"); jsonp(INV_URL+"?fn=status","onStatus"); }
    window.onStock = (p)=>{ stockMap=(p&&p.stock)||{}; inventoryActive=!!(p&&p.active); };
    window.onStatus = (p)=>{ invStatus.textContent = (p&&p.active) ? "Būsena: Inventorizacija aktyvi" : "Būsena: Normalus režimas"; lastInvStart = (p&&p.startedAt)||null; };
    setInterval(loadStock, 60000);

    /* ===== products local ===== */
    function setLocalProduct(ean,name,unit,price){ products[ean]={name,unit,price:Number(price||0)}; saveProducts(); }

    /* ===== handle EAN ===== */
    function handleEAN(ean){
      if (currentRoute==="sell"){
        const p=products[ean];
        if (!p){ hide(scannerScreen); sellInfo.innerHTML=`<div class="tag">EAN: ${ean}</div><div class="tag err">Nežinoma prekė — kreipkitės į administratorių</div>`; sellChips.classList.add("hidden"); qtyInput.value=""; priceInput.value=""; priceInput.disabled=true; show(sellPanel); return; }
        prepareSellUI(ean,p);
      } else if (currentRoute==="in"){
        const p=products[ean]; if (p) prepareInExisting(ean,p); else prepareInNew(ean);
      } else if (currentRoute==="check"){
        prepareCheckUI(ean, products[ean]||null);
      } else if (currentRoute==="price"){
        const p=products[ean]; hide(scannerScreen);
        if (!p){ priceInfo.innerHTML=`<div class="tag">EAN: ${ean}</div><div class="tag err">Nežinoma prekė (pirmiausia priimkite IN režimu)</div>`; show(pricePanel); return; }
        priceInfo.innerHTML=`<div class="tag">EAN: ${ean}</div><div class="tag">${p.name||"-"}</div><div class="tag">Unit: ${p.unit||"-"}</div><div class="tag">Dabartinė kaina: ${formatEUR(p.price)}</div>`;
        priceNew.value=""; show(pricePanel);
      } else if (currentRoute==="inventory" || currentRoute==="inventory-scan"){
        handleEAN_inventory(ean);
      }
    }

    /* ===== SELL ===== */
    function prepareSellUI(ean,p){ hide(scannerScreen);
      const sysQty = stockMap[ean];
      sellInfo.innerHTML = `
        <div class="tag">EAN: ${ean}</div>
        <div class="tag">${p.name||"-"}</div>
        <div class="tag">Unit: ${p.unit||"-"}</div>
        <div class="tag">Kaina: ${formatEUR(p.price)}</div>
        <div class="tag">Likutis: ${sysQty===undefined?"—":sysQty}</div>`;
      qtyLabel.textContent = p.unit==="ml" ? "Kiek ml?" : "Kiek vnt?";
      qtyInput.value = p.unit==="ml" ? "" : "1";
      priceInput.value = (p.price ?? 0).toFixed(2).replace(".", ","); priceInput.disabled=true;

      if (p.unit==="ml"){ sellChips.innerHTML=""; ["30","40","50","100"].forEach(v=>{ const c=document.createElement("div"); c.className="chip"; c.textContent=v+" ml"; c.onclick=()=>{ qtyInput.value=v; }; sellChips.appendChild(c); }); sellChips.classList.remove("hidden"); } else sellChips.classList.add("hidden");
      show(sellPanel); qtyInput.focus();
    }
    function enableOverride(){ priceInput.disabled=false; priceInput.focus(); }
    function confirmSale(){
      const ean=lastEAN, p=products[ean]; if (!p){ popup("Nežinoma prekė"); return; }
      const qty=parseInt((qtyInput.value||"0").replace(",",".").trim(),10); if (!(qty>0)){ popup("Įveskite kiekį"); return; }
      const override=!priceInput.disabled; let unitPrice=parseCommaNumber(priceInput.value); if (!override) unitPrice=Number(p.price||0);
      const payload={ "EAN":ean,"UnitName":p.name||"","Qty":qty,"Unit":p.unit||"","UnitPrice":unitPrice,"Override":override,"user_id":currentUser?.id||"","EventId":"sale_"+Date.now()+"_"+Math.random().toString(36).slice(2,8) };
      enqueue(OUT_URL,payload); postNow(OUT_URL,payload); restartScannerFlow();
    }

    /* ===== IN ===== */
    function prepareInExisting(ean,p){ hide(scannerScreen); hide(inNewPanel);
      inInfo.innerHTML = `<div class="tag">EAN: ${ean}</div><div class="tag">${p.name||"-"}</div><div class="tag">Unit: ${p.unit||"-"}</div><div class="tag">Kaina: ${formatEUR(p.price)}</div>`;
      inQty.value=""; show(inPanel); inQty.focus();
    }
    function confirmIn(){
      const ean=lastEAN, p=products[ean]; const qty=parseInt((inQty.value||"0").replace(",",".").trim(),10); if (!(qty>0)){ popup("Įveskite kiekį"); return; }
      const payload={ "EAN":ean,"UnitName":p?.name||"","Qty":qty,"Unit":p?.unit||"","Price":p?.price||0,"user_id":currentUser?.id||"","EventId":"in_"+Date.now()+"_"+Math.random().toString(36).slice(2,8) };
      enqueue(IN_URL,payload); postNow(IN_URL,payload); restartScannerFlow();
    }
    function prepareInNew(ean){ hide(scannerScreen); hide(inPanel); newEAN.textContent=ean; newName.value=""; newUnit.value="ml"; newPrice.value=""; newQty.value=""; show(inNewPanel); newName.focus(); }
    function saveNewAndIn(){
      const ean=lastEAN, name=(newName.value||"").trim(), unit=newUnit.value, price=parseCommaNumber(newPrice.value), qty=parseInt((newQty.value||"0").replace(",",".").trim(),10);
      if (!name){ popup("Įveskite pavadinimą"); return; } if (!(qty>0)){ popup("Įveskite kiekį"); return; }
      setLocalProduct(ean,name,unit,price);
      const payload={ "EAN":ean,"UnitName":name,"Qty":qty,"Unit":unit,"Price":price,"user_id":currentUser?.id||"","EventId":"in_"+Date.now()+"_"+Math.random().toString(36).slice(2,8) };
      enqueue(IN_URL,payload); postNow(IN_URL,payload); restartScannerFlow();
    }

    /* ===== CHECK ===== */
    function prepareCheckUI(ean,p){ hide(scannerScreen);
      const name=p?(p.name||"—"):"—", unit=p?(p.unit||"—"):"—", price=p?formatEUR(p.price):"—", sysQty=stockMap[ean];
      chkInfo.innerHTML = `<div class="tag">EAN: ${ean}</div><div class="tag">Pavadinimas: ${name}</div><div class="tag">Unit: ${unit}</div><div class="tag">Kaina: ${price}</div><div class="tag">Kiekis (sisteminiai): ${sysQty===undefined?"—":sysQty}</div>`;
      show(chkPanel);
    }

    /* ===== GLOBAL PRICE ===== */
    function confirmGlobalPrice(){
      const ean=lastEAN, p=products[ean]; if (!p){ popup("Nežinoma prekė"); return; }
      const price=parseCommaNumber(priceNew.value); if (!(price>=0)){ popup("Įveskite kainą"); return; }
      setLocalProduct(ean,p.name||"",p.unit||"",price);
      const payload={ "EAN":ean,"UnitName":p.name||"","Qty":0,"Unit":p.unit||"","Price":price,"user_id":currentUser?.id||"","EventId":"in_"+Date.now()+"_"+Math.random().toString(36).slice(2,8) };
      enqueue(IN_URL,payload); postNow(IN_URL,payload); popup("Kaina pakeista"); restartScannerFlow();
    }

    /* ===== INVENTORY (333) ===== */
    function startInventory(){ const date=invDate.value||new Date().toISOString().slice(0,10);
      if (!confirm(`Pradėti inventorizaciją ${date}?`)) return;
      postNow(INV_URL,{action:"start",date,user_id:currentUser?.id||""}); popup("Inventorizacija pradėta"); currentRoute="inventory-scan"; scanAgain(); setTimeout(loadStock,800);
    }
    function handleEAN_inventory(ean){ hide(scannerScreen); const p=products[ean]||{}, sysQty=stockMap[ean];
      invInfo.innerHTML = `<div class="tag">EAN: ${ean}</div><div class="tag">Pavadinimas: ${p.name||"—"}</div><div class="tag">Sisteminiai: ${sysQty===undefined?"—":sysQty}</div>`;
      invQty.value=""; show(invCount); invQty.focus();
    }
    function confirmInvCount(){
      const ean=lastEAN, p=products[ean]||{}, qty=parseInt((invQty.value||"0").replace(",",".").trim(),10);
      if (!(qty>=0)){ popup("Įveskite kiekį"); return; }
      enqueue(INV_URL,{action:"count",EAN:ean,NAME:p.name||"",QTY:qty,user_id:currentUser?.id||""}); postNow(INV_URL,{action:"count",EAN:ean,NAME:p.name||"",QTY:qty,user_id:currentUser?.id||""});
      restartScannerFlow(); setTimeout(loadStock,800);
    }
    function closeInventory(){
      if (!confirm("Ar tikrai uždaryti inventorizaciją?")) return;
      postNow(INV_URL,{action:"close",user_id:currentUser?.id||""}); popup("Inventorizacija uždaryta");
      // parodyti ataskaitą nuo starto iki šiandien
      if (!lastInvStart){ jsonp(INV_URL+"?fn=status","onGotInvStatus"); } else { buildInvReport(lastInvStart); }
      setTimeout(loadStock,800);
    }
    window.onGotInvStatus = (p)=>{ const started=(p&&p.startedAt)||null; if (started) buildInvReport(String(started).slice(0,10)); };
    function buildInvReport(fromDate){ const to = new Date().toISOString().slice(0,10); jsonp(OUT_URL+`?fn=sales_range&from=${fromDate}&to=${to}`,"onInvReport"); }
    window.onInvReport = (r)=>{ hide(scannerScreen); hide(invStart); hide(invCount); reportTitle.textContent="Ataskaita nuo inventorizacijos pradžios"; renderReport(r, `Nuo: ${r.from} iki: ${r.to}`); };

    /* ===== 222 – Dienos pardavimai ===== */
    function showDailySales(){ const d=prompt("Įveskite datą (YYYY-MM-DD)", new Date().toISOString().slice(0,10)); if (!d) return; jsonp(OUT_URL+`?fn=sales&date=${d}`,"onDailySales"); }
    window.onDailySales = (r)=>{ reportTitle.textContent=`Dienos pardavimai (${r.date})`; renderReport(r, `Iš viso: ${r.totals.qty} vnt | Apyvarta: ${formatEUR(r.totals.revenue)}`); hide(scannerScreen); show(reportPanel); };

    /* ===== report render ===== */
    function renderReport(r, headerTxt){ reportInfo.textContent=headerTxt||""; const tb=reportTable; tb.innerHTML=""; let tq=0,tr=0;
      if (r&&r.rows){ r.rows.forEach(row=>{ const rev=Number(row.Qty||0)*Number(row.UnitPrice||0); const trEl=document.createElement("tr"); trEl.innerHTML=`<td>${row.EAN||""}</td><td>${row.UnitName||""}</td><td>${row.Qty||0}</td><td>${formatEUR(rev)}</td>`; tb.appendChild(trEl); tq+=Number(row.Qty||0); tr+=rev; }); }
      const t=document.createElement("tr"); t.innerHTML=`<td><b>VISO</b></td><td></td><td><b>${tq}</b></td><td><b>${formatEUR(tr)}</b></td>`; tb.appendChild(t); show(reportPanel);
    }

    /* ===== settings (444) ===== */
    function refreshStatus(){ jsonp(INV_URL+"?fn=status","onStatus"); diagQuick(); }
    function diagQuick(){
      const items = [];
      items.push("Online: "+(navigator.onLine?"yes":"no"));
      items.push("Queue: "+queue.length);
      // health pings
      jsonp(IN_URL+"?fn=health","onInHealth"); jsonp(OUT_URL+"?fn=health","onOutHealth");
      diagInfo.textContent = items.join(" | ");
    }
    window.onInHealth = (h)=>{ if (!h||h.error){ diagInfo.textContent += " | IN: ERR"; } else { diagInfo.textContent += ` | IN ok (rows:${h.lastRow||0})`; } };
    window.onOutHealth = (h)=>{ if (!h||h.error){ diagInfo.textContent += " | OUT: ERR"; } else { diagInfo.textContent += ` | OUT ok (rows:${h.lastRow||0})`; } };
    function testOut(){ const p={"EAN":"TESTEAN","UnitName":"TEST","Qty":1,"Unit":"pcs","UnitPrice":0.01,"Override":false,"user_id":currentUser?.id||"","EventId":"test_out_"+Date.now()}; enqueue(OUT_URL,p); postNow(OUT_URL,p); popup("OUT test išsiųstas"); }
    function testIn(){ const p={"EAN":"TESTEAN","UnitName":"TEST","Qty":1,"Unit":"pcs","Price":0.01,"user_id":currentUser?.id||"","EventId":"test_in_"+Date.now()}; enqueue(IN_URL,p); postNow(IN_URL,p); popup("IN test išsiųstas"); }
    function resetApp(){ if (!confirm("Išvalyti vietinę būseną?")) return; products={}; localStorage.setItem("products_cache","{}"); queue=[]; saveQueue(); popup("Išvalyta"); }

    /* ===== network ===== */
    function postNow(url,obj){ fetch(url,{method:"POST",mode:"no-cors",headers:{ "Content-Type":"application/json" },body:JSON.stringify(obj)}).catch(()=>{}); }
    function syncNow(){ const items=[...queue]; items.forEach(it=>postNow(it.url,it.payload)); loadStock(); popup("Sync paleistas"); }

    /* ===== init ===== */
    document.addEventListener("click", initAudio, { once:true });
  </script>
</body>
</html>







