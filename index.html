<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <title>Store POS (Web)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- force fresh -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#0f1012;--card:#17181c;--txt:#fff;--muted:#b6bdc6;
      --pri:#00aaff;--pri2:#0088cc;--ok:#00ff99;--warn:#ffcc00;--err:#ff5050;
      --accent:#1f6feb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;min-height:100vh}
    h1,h2,h3{margin:10px 0 6px}
    .hidden{display:none}
    .btn{font-size:1.06rem;padding:12px 18px;margin:8px;border:none;border-radius:12px;background:var(--pri);color:#fff;cursor:pointer}
    .btn:hover{background:var(--pri2)}
    .btn-ghost{background:#2a2f36}
    .btn-danger{background:#c83532}
    .card{width:92vw;max-width:760px;background:var(--card);padding:16px;border-radius:16px;box-shadow:0 0 24px rgba(0,0,0,.35);margin:12px 0}
    .grid{display:grid;gap:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row>*{flex:1}
    label{font-weight:600}
    input,select{width:100%;padding:12px;border:none;border-radius:10px;margin:6px 0;font-size:1.05rem;background:#20242b;color:#fff}
    .topbar{position:fixed;top:10px;right:10px;z-index:50;display:flex;gap:8px}
    .topbar .btn{padding:8px 12px;font-size:.95rem}
    .tag{display:inline-block;background:#232833;border:1px solid #2e3440;border-radius:10px;padding:5px 8px;margin:3px;font-size:.95rem;color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    #scannerWrap{position:relative;width:100vw;height:72vh;max-height:74vh}
    #scanner{width:100%;height:100%}
    #flash{position:absolute;inset:0;background:rgba(0,255,100,.35);display:none;animation:flash .25s ease-out;pointer-events:none}
    #scanBadge{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1);
      background:rgba(15,16,18,.85);border:2px solid #00ffaa;box-shadow:0 0 30px rgba(0,255,170,.45);
      padding:10px 16px;border-radius:999px;font-weight:700;letter-spacing:.6px;display:none
    }
    @keyframes flash{from{opacity:1}to{opacity:0}}
    #popup{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#2c313a;padding:10px 16px;border-radius:10px;display:none;border:1px solid #3a404c}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{padding:8px 12px;border-radius:999px;background:#232833;border:1px solid #2e3440;cursor:pointer}
    .chip:hover{background:#2a3040}
    .muted{opacity:.85;color:var(--muted)}
    .spacer{height:12px}
    code.small{font-size:.9rem;color:#aab2bd}
    .divider{height:1px;background:#242932;margin:10px 0}
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar hidden" id="topbar">
    <button class="btn btn-ghost" id="btnBack" onclick="goHome()">Grįžti</button>
    <button class="btn btn-ghost" onclick="syncNow()">Sync now</button>
    <button class="btn btn-danger" onclick="logout()">Atsijungti</button>
  </div>

  <!-- Login -->
  <div id="login" class="card">
    <h1>Prisijungimas</h1>
    <input id="loginCode" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Įveskite vartotojo kodą" />
    <button class="btn" onclick="doLogin()">Prisijungti</button>
  </div>

  <!-- Home -->
  <div id="home" class="card hidden">
    <h1>Store POS</h1>
    <div id="who" class="muted"></div>
    <div id="menuButtons" class="row" style="margin-top:8px"></div>
    <div class="divider"></div>
    <div class="muted">Versija: <span id="ver">v2.3.0</span></div>
  </div>

  <!-- Shared scanner -->
  <div id="scannerScreen" class="hidden">
    <div id="scannerWrap">
      <div id="scanner"></div>
      <div id="flash"></div>
      <div id="scanBadge">SCANNED</div>
    </div>
  </div>

  <!-- SELL -->
  <div id="sellPanel" class="card hidden">
    <h2>Pardavimas</h2>
    <div id="sellInfo" class="muted"></div>
    <div class="chips hidden" id="sellChips"></div>
    <div class="row">
      <div>
        <label id="qtyLabel" for="qtyInput">Kiekis</label>
        <input id="qtyInput" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Įveskite kiekį" />
      </div>
      <div>
        <label>Kaina / vnt</label>
        <div class="row" style="gap:6px">
          <input id="priceInput" type="tel" inputmode="decimal" placeholder="0,00" disabled />
          <button class="btn" id="btnOverride" onclick="enableOverride()">Keisti kainą</button>
        </div>
      </div>
    </div>
    <button class="btn" onclick="confirmSale()">ENTER</button>
  </div>

  <!-- IN EXISTING -->
  <div id="inPanel" class="card hidden">
    <h2>Prekių priėmimas</h2>
    <div id="inInfo" class="muted"></div>
    <label>Gautas kiekis</label>
    <input id="inQty" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Kiekis" />
    <button class="btn" onclick="confirmIn()">Įrašyti</button>
  </div>

  <!-- IN NEW -->
  <div id="inNewPanel" class="card hidden">
    <h2>Nauja prekė</h2>
    <div><b>EAN:</b> <span id="newEAN"></span></div>
    <label>Pavadinimas</label>
    <input id="newName" placeholder="Pvz., Dior Sauvage" />
    <label>Vienetas</label>
    <select id="newUnit">
      <option value="ml">ml (kvepalai)</option>
      <option value="pcs">vnt (kitos prekės)</option>
    </select>
    <label>Bazinė kaina / vienetui</label>
    <input id="newPrice" type="tel" inputmode="decimal" placeholder="0,00" />
    <label>Gautas kiekis</label>
    <input id="newQty" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Kiekis" />
    <button class="btn" onclick="saveNewAndIn()">Išsaugoti ir įrašyti</button>
  </div>

  <!-- CHECK STOCK -->
  <div id="chkPanel" class="card hidden">
    <h2>Tikrinti likutį</h2>
    <div id="chkInfo" class="muted"></div>
    <div class="spacer"></div>
    <button class="btn" onclick="scanAgain()">Skenuoti vėl</button>
  </div>

  <!-- GLOBAL PRICE (222) -->
  <div id="pricePanel" class="card hidden">
    <h2>Keisti kainą (visam stockui)</h2>
    <div id="priceInfo" class="muted"></div>
    <label>Nauja kaina / vienetui</label>
    <input id="priceNew" type="tel" inputmode="decimal" placeholder="0,00" />
    <button class="btn" onclick="confirmGlobalPrice()">Patvirtinti kainą</button>
  </div>

  <!-- INVENTORY (333) -->
  <div id="invStart" class="card hidden">
    <h2>Inventorizacija</h2>
    <label>Inventorizacijos data</label>
    <input id="invDate" type="date" />
    <button class="btn" onclick="startInventory()">Pradėti inventorizaciją</button>
  </div>

  <div id="invCount" class="card hidden">
    <h2>Skaičiavimas</h2>
    <div id="invInfo" class="muted"></div>
    <label>Naujas suskaičiuotas kiekis</label>
    <input id="invQty" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="Kiekis" />
    <button class="btn" onclick="confirmInvCount()">Įrašyti ir kitas</button>
  </div>

  <div id="invClose" class="card hidden">
    <h2>Uždaryti inventorizaciją</h2>
    <button class="btn" onclick="closeInventory()">Uždaryti</button>
  </div>

  <!-- SETTINGS (444 only) -->
  <div id="settings" class="card hidden">
    <h2>Nustatymai (IT)</h2>
    <div id="invStatus" class="muted">Būsena: —</div>
    <div class="divider"></div>
    <h3>IN/OUT šaltiniai</h3>
    <div class="grid">
      <div>
        <label>IN sheet ID</label>
        <input id="inId" placeholder="1abc... (Google Sheet ID)" />
      </div>
      <div>
        <label>OUT sheet ID</label>
        <input id="outId" placeholder="1xyz... (Google Sheet ID)" />
      </div>
    </div>
    <div class="row">
      <button class="btn" onclick="setSources()">Išsaugoti šaltinius</button>
      <button class="btn btn-ghost" onclick="refreshConfig()">Atnaujinti būseną</button>
    </div>
    <div class="divider"></div>
    <h3>Likučių režimas</h3>
    <div class="row">
      <button class="btn btn-ghost" onclick="syncNow()">Sync now</button>
      <button class="btn" onclick="switchToNormal()">Grąžinti į normalų (IN−OUT)</button>
    </div>
    <p class="muted"><small>Pastaba: inventorizaciją taip pat gali uždaryti 333 vartotojas per savo ekraną.</small></p>
    <div class="divider"></div>
    <div class="muted">Versija: <code class="small" id="ver2">v2.3.0</code></div>
  </div>

  <div id="popup"></div>

  <script src="https://unpkg.com/html5-qrcode?v=2"></script>
  <script>
    /* ===== CONFIG ===== */
    const OUT_URL = "https://script.google.com/macros/s/AKfycbwuu6IvwkwvubIpg9zSbuT9Alj_cZcWWxSM62ZVt2z3zf3IxiwxdtLMor1IRt943lg9uQ/exec";
    const IN_URL  = "https://script.google.com/macros/s/AKfycbztiJK4J-wqvPnYYI_MPnXVxEMVrUwf8s6G35NvXq8Q4-Q_eosz5NzOwkaieoLhycFv/exec";
    const INV_URL = "https://script.google.com/macros/s/AKfycbx8lt1QANX-cXF1WyNx9fon7Ei6G4qWksnpW9cu-qlnr1DhWp-_h39vx8PdMM-oQHUGhQ/exec";
    const RETRY_MS = 30000, MAX_RETRIES = 3;
    const APP_VERSION = "v2.3.0";

    /* ===== STATE ===== */
    let currentUser = null; // {id, role}
    let html5Qr = null, lastEAN = null, currentRoute = null;
    // local "products" from IN events (by EAN): { name, unit, price }
    let products = JSON.parse(localStorage.getItem("products_cache")||"{}");
    // stock map from backend: { EAN: qty }, plus flags
    let stockMap = {}, stockSource = "computed", inventoryActive = false;

    // resend buffer (safe due to EventId duplicate guard)
    let queue = JSON.parse(localStorage.getItem("send_queue")||"[]"); // [{url,payload,ts}]
    function saveQueue(){ localStorage.setItem("send_queue", JSON.stringify(queue.slice(-200))); }
    function enqueue(url,payload){ queue.push({url, payload, ts:Date.now()}); saveQueue(); }

    /* ===== UI REFS ===== */
    const topbar = document.getElementById("topbar");
    const btnBack = document.getElementById("btnBack");

    const login = document.getElementById("login");
    const loginCode = document.getElementById("loginCode");
    const home = document.getElementById("home");
    const who = document.getElementById("who");
    const menuButtons = document.getElementById("menuButtons");
    document.getElementById("ver").textContent = APP_VERSION;
    document.getElementById("ver2").textContent = APP_VERSION;

    const scannerScreen = document.getElementById("scannerScreen");
    const flash = document.getElementById("flash");
    const scanBadge = document.getElementById("scanBadge");

    const sellPanel = document.getElementById("sellPanel");
    const sellInfo = document.getElementById("sellInfo");
    const sellChips = document.getElementById("sellChips");
    const qtyLabel = document.getElementById("qtyLabel");
    const qtyInput = document.getElementById("qtyInput");
    const priceInput = document.getElementById("priceInput");

    const inPanel = document.getElementById("inPanel");
    const inInfo = document.getElementById("inInfo");
    const inQty = document.getElementById("inQty");

    const inNewPanel = document.getElementById("inNewPanel");
    const newEAN = document.getElementById("newEAN");
    const newName = document.getElementById("newName");
    const newUnit = document.getElementById("newUnit");
    const newPrice = document.getElementById("newPrice");
    const newQty = document.getElementById("newQty");

    const chkPanel = document.getElementById("chkPanel");
    const chkInfo = document.getElementById("chkInfo");

    const pricePanel = document.getElementById("pricePanel");
    const priceInfo = document.getElementById("priceInfo");
    const priceNew = document.getElementById("priceNew");

    const invStart = document.getElementById("invStart");
    const invCount = document.getElementById("invCount");
    const invClose = document.getElementById("invClose");
    const invDate = document.getElementById("invDate");
    const invInfo = document.getElementById("invInfo");
    const invQty = document.getElementById("invQty");

    const settings = document.getElementById("settings");
    const invStatus = document.getElementById("invStatus");
    const inId = document.getElementById("inId");
    const outId = document.getElementById("outId");

    /* ===== UTIL ===== */
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function popup(msg){
      const p = document.getElementById("popup");
      p.textContent = msg; p.style.display="block";
      setTimeout(()=>p.style.display="none", 2800);
    }
    function vibrate(ms=45){ if (navigator.vibrate) try{ navigator.vibrate(ms);}catch{} }
    // Audio: create once after first user gesture
    let beepCtx=null;
    function initAudio(){
      if (beepCtx) return;
      try{ beepCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch{}
    }
    function beep(){
      if (!beepCtx) return;
      try{
        const osc = beepCtx.createOscillator();
        const gain = beepCtx.createGain();
        osc.type="square"; osc.frequency.setValueAtTime(1100, beepCtx.currentTime);
        gain.gain.value=.06; osc.connect(gain).connect(beepCtx.destination);
        osc.start(); osc.stop(beepCtx.currentTime+.08);
      }catch{}
    }
    function flashFX(){
      flash.style.display="block"; scanBadge.style.display="block";
      setTimeout(()=>{ flash.style.display="none"; scanBadge.style.display="none"; }, 320);
    }
    function parseCommaNumber(x){
      if (typeof x==="number") return x;
      if (!x) return 0;
      return Number(String(x).trim().replace(",", "."));
    }
    function formatEUR(n){ const v = Number(n||0); return v.toFixed(2).replace(".", ",") + " €"; }
    function saveProducts(){ localStorage.setItem("products_cache", JSON.stringify(products)); }

    /* ===== LOGIN / LOGOUT ===== */
    function roleByCode(code){
      if (code==="111") return "Pardavėja";
      if (code==="222") return "Savininkas";
      if (code==="333") return "Inventorizacija";
      if (code==="444") return "IT";
      return null;
    }
    function doLogin(){
      initAudio(); // enable beep on iOS after user gesture
      const code = (loginCode.value||"").trim();
      const role = roleByCode(code);
      if (!role){ popup("Neteisingas kodas"); return; }
      currentUser = { id: code, role };
      loginCode.value="";
      showHome();
      syncNow(); // first quick sync on login
    }
    function logout(){
      stopScanner();
      currentUser = null;
      hide(topbar);
      [home, scannerScreen, sellPanel, inPanel, inNewPanel, chkPanel, pricePanel, invStart, invCount, invClose, settings].forEach(hide);
      show(login);
    }

    /* ===== HOME ===== */
    function showHome(){
      hide(login);
      show(home);
      who.textContent = `Prisijungęs: ${currentUser.role}`;
      buildMenu();
      hide(scannerScreen); hide(sellPanel); hide(inPanel); hide(inNewPanel); hide(chkPanel); hide(pricePanel);
      hide(invStart); hide(invCount); hide(invClose); hide(settings);
      hide(topbar);
    }
    function buildMenu(){
      menuButtons.innerHTML="";
      const add = (txt, fn)=>{ const b=document.createElement("button"); b.className="btn"; b.textContent=txt; b.onclick=fn; menuButtons.appendChild(b); };
      if (currentUser.id==="111"){ // Pardavėja
        add("Parduoti", ()=>goRoute("sell"));
        add("Prekių priėmimas", ()=>goRoute("in"));
        add("Tikrinti likutį", ()=>goRoute("check"));
      } else if (currentUser.id==="222"){ // Savininkas
        add("Parduoti", ()=>goRoute("sell"));
        add("Prekių priėmimas", ()=>goRoute("in"));
        add("Tikrinti likutį", ()=>goRoute("check"));
        add("Keisti kainą (globaliai)", ()=>goRoute("price"));
      } else if (currentUser.id==="333"){ // Inventorizacija
        add("Inventorizacija", ()=>goRoute("inventory"));
      } else if (currentUser.id==="444"){ // IT
        add("Nustatymai (IT)", ()=>goRoute("settings"));
      }
    }

    /* ===== ROUTING ===== */
    function goRoute(r){
      currentRoute = r;
      show(topbar);
      hide(home);
      if (r==="sell" || r==="in" || r==="check" || r==="price" || r==="inventory-scan"){
        startScanner();
      }
      if (r==="inventory"){
        hide(scannerScreen); show(invStart); hide(invCount); show(invClose); // invClose visible for 333
      }
      if (r==="settings"){
        hide(scannerScreen); show(settings); refreshConfig();
      }
    }
    function goHome(){
      stopScanner();
      showHome();
    }

    /* ===== SCANNER ===== */
    function startScanner(){
      show(scannerScreen);
      btnBack.disabled = false;
      stopScanner();
      html5Qr = new Html5Qrcode("scanner");
      html5Qr.start({facingMode:"environment"},{
        fps:30, qrbox:{width:320,height:220},
        experimentalFeatures:{useBarCodeDetectorIfSupported:true},
        formatsToSupport:[
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.UPC_A,
          Html5QrcodeSupportedFormats.UPC_E,
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.CODE_39,
          Html5QrcodeSupportedFormats.QR_CODE
        ],
        rememberLastUsedCamera:true
      }, onScan).catch(err=>console.error(err));
    }
    function stopScanner(){ if (html5Qr){ try{ html5Qr.stop(); }catch{} } }
    function onScan(txt){
      if (lastEAN) return;
      lastEAN = String(txt).trim();
      vibrate(); beep(); flashFX();
      html5Qr.stop().then(()=>handleEAN(lastEAN));
    }
    function scanAgain(){
      hide(chkPanel); hide(pricePanel); hide(sellPanel); hide(inPanel); hide(inNewPanel); hide(invCount);
      lastEAN=null; startScanner();
    }

    /* ===== STOCK (JSONP) ===== */
    function jsonp(url, cb){ const s=document.createElement("script"); s.src=url+(url.includes("?")?"&":"?")+"callback="+cb+"&_="+Date.now(); document.body.appendChild(s); s.onload=()=>s.remove(); }
    function loadStock(){ jsonp(INV_URL+"?fn=stock","onStock"); }
    window.onStock = function(payload){
      if (!payload) return;
      stockMap = payload.stock || {};
      stockSource = payload.source || "computed";
      inventoryActive = !!payload.active;
      // Update status if settings open
      invStatus.textContent = `Būsena: ${inventoryActive ? "Inventorizacija aktyvi (šaltinis: 3-ias sheetas)" : "Normalus režimas (IN−OUT)"}`;
    };
    // periodic refresh
    setInterval(loadStock, 60000);
    // first lazy refresh after login
    function afterLoginRefresh(){ setTimeout(loadStock, 600); }

    /* ===== PRODUCTS (local, from IN 'new product' events) ===== */
    function setLocalProduct(ean, name, unit, price){ products[ean] = { name, unit, price: Number(price||0) }; saveProducts(); }

    /* ===== HANDLE EAN per route ===== */
    function handleEAN(ean){
      if (currentRoute==="sell"){
        const p = products[ean];
        if (!p){
          hide(scannerScreen);
          sellInfo.innerHTML = `<div class="tag">EAN: ${ean}</div><div class="tag err">Nežinoma prekė — kreipkitės į administratorių</div>`;
          hide(sellChips);
          qtyInput.value=""; priceInput.value=""; priceInput.disabled=true;
          show(sellPanel); return;
        }
        prepareSellUI(ean,p);
      }
      else if (currentRoute==="in"){
        const p = products[ean];
        if (p) prepareInExisting(ean,p); else prepareInNew(ean);
      }
      else if (currentRoute==="check"){
        prepareCheckUI(ean, products[ean]||null);
      }
      else if (currentRoute==="price"){
        const p = products[ean];
        hide(scannerScreen);
        if (!p){
          priceInfo.innerHTML = `<div class="tag">EAN: ${ean}</div><div class="tag err">Nežinoma prekė (pirmiausia priimkite IN režimu)</div>`;
          show(pricePanel); return;
        }
        priceInfo.innerHTML = `
          <div class="tag">EAN: ${ean}</div>
          <div class="tag">${p.name||"-"}</div>
          <div class="tag">Unit: ${p.unit||"-"}</div>
          <div class="tag">Dabartinė kaina: ${formatEUR(p.price)}</div>
        `;
        priceNew.value="";
        show(pricePanel);
      }
      else if (currentRoute==="inventory" || currentRoute==="inventory-scan"){
        handleEAN_inventory(ean);
      }
    }

    /* ===== SELL ===== */
    function prepareSellUI(ean, p){
      hide(scannerScreen);
      const sysQty = stockMap[ean]; // could be undefined
      sellInfo.innerHTML = `
        <div class="tag">EAN: ${ean}</div>
        <div class="tag">${p.name||"-"}</div>
        <div class="tag">Unit: ${p.unit||"-"}</div>
        <div class="tag">Kaina: ${formatEUR(p.price)}</div>
        <div class="tag">Likutis: ${sysQty===undefined?"—":sysQty}</div>
        <div class="tag muted">Šaltinis: ${inventoryActive?"Inventorizacija":"IN−OUT"}</div>
      `;
      qtyLabel.textContent = p.unit==="ml" ? "Kiek ml?" : "Kiek vnt?";
      qtyInput.value = p.unit==="ml" ? "" : "1";
      priceInput.value = (p.price ?? 0).toFixed(2).replace(".", ",");
      priceInput.disabled = true;

      if (p.unit==="ml"){
        sellChips.innerHTML="";
        ["30","40","50","100"].forEach(v=>{
          const c=document.createElement("div"); c.className="chip"; c.textContent=v+" ml";
          c.onclick=()=>{ qtyInput.value=v; };
          sellChips.appendChild(c);
        });
        show(sellChips);
      } else { hide(sellChips); }
      show(sellPanel);
      qtyInput.focus();
    }
    function enableOverride(){ priceInput.disabled=false; priceInput.focus(); }
    function confirmSale(){
      const ean = lastEAN; const p = products[ean];
      if (!p){ popup("Nežinoma prekė"); return; }
      const qty = parseInt((qtyInput.value||"0").replace(",",".").trim(),10);
      if (!(qty>0)){ popup("Įveskite kiekį"); return; }
      const override = !priceInput.disabled;
      let unitPrice = parseCommaNumber(priceInput.value);
      if (!override) unitPrice = Number(p.price||0);

      const payload = {
        "EAN": ean, "UnitName": p.name||"", "Qty": qty, "Unit": p.unit||"",
        "UnitPrice": unitPrice, "Override": override, "user_id": currentUser?.id||"",
        "EventId": "sale_"+Date.now()+"_"+Math.random().toString(36).slice(2,8)
      };
      enqueue(OUT_URL, payload);
      postNow(OUT_URL, payload);

      // ready for next immediately
      restartScannerFlow();
    }

    /* ===== IN (existing/new) ===== */
    function prepareInExisting(ean,p){
      hide(scannerScreen); hide(inNewPanel);
      inInfo.innerHTML = `
        <div class="tag">EAN: ${ean}</div>
        <div class="tag">${p.name||"-"}</div>
        <div class="tag">Unit: ${p.unit||"-"}</div>
        <div class="tag">Kaina: ${formatEUR(p.price)}</div>
      `;
      inQty.value="";
      show(inPanel); inQty.focus();
    }
    function confirmIn(){
      const ean = lastEAN; const p = products[ean];
      const qty = parseInt((inQty.value||"0").replace(",",".").trim(),10);
      if (!(qty>0)){ popup("Įveskite kiekį"); return; }
      const payload = {
        "EAN": ean, "UnitName": p?.name||"", "Qty": qty, "Unit": p?.unit||"",
        "Price": p?.price||0, "user_id": currentUser?.id||"",
        "EventId":"in_"+Date.now()+"_"+Math.random().toString(36).slice(2,8)
      };
      enqueue(IN_URL, payload);
      postNow(IN_URL, payload);

      restartScannerFlow();
    }
    function prepareInNew(ean){
      hide(scannerScreen); hide(inPanel);
      newEAN.textContent = ean;
      newName.value=""; newUnit.value="ml"; newPrice.value=""; newQty.value="";
      show(inNewPanel); newName.focus();
    }
    function saveNewAndIn(){
      const ean = lastEAN;
      const name = (newName.value||"").trim();
      const unit = newUnit.value;
      const price = parseCommaNumber(newPrice.value);
      const qty = parseInt((newQty.value||"0").replace(",",".").trim(),10);
      if (!name){ popup("Įveskite pavadinimą"); return; }
      if (!(qty>0)){ popup("Įveskite kiekį"); return; }

      setLocalProduct(ean, name, unit, price);

      const payload = {
        "EAN": ean, "UnitName": name, "Qty": qty, "Unit": unit, "Price": price,
        "user_id": currentUser?.id||"", "EventId":"in_"+Date.now()+"_"+Math.random().toString(36).slice(2,8)
      };
      enqueue(IN_URL, payload);
      postNow(IN_URL, payload);

      restartScannerFlow();
    }

    /* ===== CHECK STOCK ===== */
    function prepareCheckUI(ean, p){
      hide(scannerScreen);
      const nameTxt = p? (p.name||"—") : "—";
      const unitTxt = p? (p.unit||"—") : "—";
      const priceTxt = p? formatEUR(p.price) : "—";
      const sysQty = stockMap[ean];
      chkInfo.innerHTML = `
        <div class="tag">EAN: ${ean}</div>
        <div class="tag">Pavadinimas: ${nameTxt}</div>
        <div class="tag">Unit: ${unitTxt}</div>
        <div class="tag">Kaina: ${priceTxt}</div>
        <div class="tag">Kiekis (sisteminiai): ${sysQty===undefined?"—":sysQty}</div>
        <div class="tag muted">Šaltinis: ${inventoryActive?"Inventorizacija":"IN−OUT"}</div>
      `;
      show(chkPanel);
    }

    /* ===== GLOBAL PRICE (222) ===== */
    function confirmGlobalPrice(){
      const ean = lastEAN; const p = products[ean];
      if (!p){ popup("Nežinoma prekė"); return; }
      const price = parseCommaNumber(priceNew.value);
      if (!(price>=0)){ popup("Įveskite kainą"); return; }
      const payload = {
        "EAN": ean, "UnitName": p.name||"", "Qty": 0, "Unit": p.unit||"", "Price": price,
        "user_id": currentUser?.id||"", "EventId":"in_"+Date.now()+"_"+Math.random().toString(36).slice(2,8)
      };
      setLocalProduct(ean, p.name||"", p.unit||"", price);
      enqueue(IN_URL, payload);
      postNow(IN_URL, payload);
      popup("Kaina pakeista");
      restartScannerFlow();
    }

    /* ===== INVENTORY (333) ===== */
    function startInventory(){
      const date = invDate.value || new Date().toISOString().slice(0,10);
      if (!confirm(`Pradėti inventorizaciją ${date}?`)) return;
      // start (not queued)
      postNow(INV_URL, { action:"start", date, user_id: currentUser?.id||"" });
      popup("Inventorizacija pradėta");
      currentRoute = "inventory-scan";
      scanAgain();
      setTimeout(loadStock, 800);
    }
    function handleEAN_inventory(ean){
      hide(scannerScreen);
      const p = products[ean] || {};
      const sysQty = stockMap[ean];
      invInfo.innerHTML = `
        <div class="tag">EAN: ${ean}</div>
        <div class="tag">Pavadinimas: ${p.name||"—"}</div>
        <div class="tag">Sisteminiai: ${sysQty===undefined?"—":sysQty}</div>
      `;
      invQty.value="";
      show(invCount); invQty.focus();
    }
    function confirmInvCount(){
      const ean = lastEAN;
      const p = products[ean]||{};
      const qty = parseInt((invQty.value||"0").replace(",",".").trim(),10);
      if (!(qty>=0)){ popup("Įveskite kiekį"); invQty.focus(); return; }
      // queue OK (upsert by EAN idempotent)
      const payload = { action:"count", EAN: ean, NAME: p.name||"", QTY: qty, user_id: currentUser?.id||"" };
      enqueue(INV_URL, payload);
      postNow(INV_URL, payload);
      restartScannerFlow();
      setTimeout(loadStock, 800);
    }
    function closeInventory(){
      if (!confirm("Ar tikrai uždaryti inventorizaciją?")) return;
      postNow(INV_URL, { action:"close", user_id: currentUser?.id||"" });
      popup("Inventorizacija uždaryta");
      setTimeout(loadStock, 800);
    }

    /* ===== SETTINGS (444) ===== */
    function refreshConfig(){
      jsonp(INV_URL+"?fn=config", "onCfg");
      jsonp(INV_URL+"?fn=status", "onCfgStatus");
    }
    window.onCfg = function(p){
      if (!p) return;
      invStatus.textContent = `Būsena: ${p.active ? "Inventorizacija aktyvi" : "Normalus režimas"}`;
    };
    window.onCfgStatus = function(p){
      if (!p) return;
      invStatus.textContent = `Būsena: ${p.active ? "Inventorizacija aktyvi" : "Normalus režimas"}${p.startedAt? " | Nuo: "+p.startedAt:""}`;
    }
    function setSources(){
      const IN_ID = inId.value.trim(), OUT_ID = outId.value.trim();
      if (!IN_ID || !OUT_ID){ popup("Įveskite abu ID"); return; }
      postNow(INV_URL, { action:"set_sources", IN_ID, OUT_ID });
      popup("Šaltiniai išsaugoti");
      setTimeout(loadStock, 800);
    }
    function switchToNormal(){
      if (!confirm("Perjungti į normalų režimą (IN−OUT)?")) return;
      postNow(INV_URL, { action:"close", user_id: currentUser?.id||"" });
      setTimeout(()=>{ loadStock(); popup("Perjungta į normalų režimą"); }, 800);
    }

    /* ===== NETWORK ===== */
    function postNow(url, obj){
      fetch(url, {
        method:"POST", mode:"no-cors",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(obj)
      }).catch(()=>{}); // we re-send on Sync anyway
    }
    function syncNow(){
      // resend buffer (safe duplicates)
      const items = [...queue];
      items.forEach(it=> postNow(it.url, it.payload));
      // refresh stock
      loadStock();
      popup("Sync paleistas");
    }

    /* ===== INIT ===== */
    // quick stock refresh every 60s set above; also initial after login
    // ensure audio initialized on first interaction
    document.addEventListener("click", initAudio, { once:true });
  </script>
</body>
</html>





